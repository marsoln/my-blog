<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="Marsoln 修行札记">
    

    <!--Author-->
    
        <meta name="author" content="Marsoln">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="javascript全栈应用实践之路 (服务器搭建篇 二)"/>
    

    <!--Open Graph Description-->
    
        <meta property="og:description" content="Marsoln 修行札记" />
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="marsoln&#39;s blog"/>

    <!--Type page-->
    
        <meta property="og:type" content="article" />
    

    <!--Page Cover-->
    

    <meta name="twitter:card" content="summary" />
    

    <!-- Title -->
    
    <title>javascript全栈应用实践之路 (服务器搭建篇 二) - marsoln&#39;s blog</title>

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css" integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd" crossorigin="anonymous">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/my-blog/css/style.css">

</head>


<body>

<div class="bg-gradient"></div>
<div class="bg-pattern"></div>

<!-- Menu -->
<!--Menu Links and Overlay-->
<div class="menu-bg">
    <div class="menu-container">
        <ul>
            
            <li class="menu-item">
                <a href="/my-blog/">
                    首页
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/my-blog/archives">
                    归档
                </a>
            </li>
            
        </ul>
    </div>
</div>

<!--Hamburger Icon-->
<nav>
    <a href="#menu"></a>
</nav>

<div class="container">

    <!-- Main Content -->
    <div class="row">
    <div class="col-sm-12">

        <!--Title and Logo-->
        <header>
    <div class="logo">
        <a href="/my-blog/"><i class="logo-icon fa fa-cube" aria-hidden="true"></i></a>
        
    </div>
</header>

        <section class="main">
            
<div class="post">

    <div class="post-header">
        <h1 class="title">
            <a href="/my-blog/2016/09/27/jsFullStackSeries/03/">
                javascript全栈应用实践之路 (服务器搭建篇 二)
            </a>
        </h1>
        <div class="post-info">
            <span class="date">2016-09-27</span>
            <a href="#disqus_thread" class="comments">留言</a>
            
        </div>
    </div>

    <div class="content">

        <!-- Gallery -->
        

        <!-- Post Content -->
        <h4 id="剧情概要"><a href="#剧情概要" class="headerlink" title="剧情概要"></a>剧情概要</h4><p>上一集,我们一起完成了一个简单的服务器 – 提供了/index 根目录的路由,/graphql 数据服务路由并且创建了一个用户模型.<br>在这一集,我们将要完成注册登录和身份验证的基本功能,并且完成对应web端的部分.</p>
<h4 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h4><p>开始撸码之前,让我们先思考两个问题:</p>
<ul>
<li>身份验证的原理是什么</li>
<li>身份验证应该在作用于什么场景</li>
</ul>
<p>可惜我并没有教科书式的答案,只有一些自己的理解:</p>
<p>首先,我认为<strong>身份验证的机制应该是在用户通过一些行为确定身份之后,携带一个自己身份的标识信息,并且可以被服务器端所认可,其必须具有唯一性</strong>,说白了就是,你登录之后,服务器为你生成一个唯一标识,你只要每次请求的时候都带着就可以了.</p>
<p>然后,其作用的场景必然是非匿名场景,譬如<strong>对于大多数数据进行Create/Update/Delete之类的操作(甚至某些敏感数据的Read操作)需要明确你的身份的时候</strong>,这样的场景就需要身份验证.</p>
<p>好,带着这个独创的结论,我们就开始实现一个authentication吧!</p>
<a id="more"></a>
<h4 id="先实现简单的路由和filter"><a href="#先实现简单的路由和filter" class="headerlink" title="先实现简单的路由和filter"></a>先实现简单的路由和filter</h4><p>让我们找到并打开server/routes/Initialize.js,做一些小小的改动,添加两个路由,对应的就是我们未来的登录和注册功能<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">let loginRoutes = require(&apos;./actions/login&apos;)</div><div class="line">let registerRoutes = require(&apos;./actions/register&apos;)</div></pre></td></tr></table></figure></p>
<p>然后,再加上两个filter,sess是我们校验session的一个过滤器,auth顾名思义,就是身份验证<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">let sess = require(&apos;../filters/session&apos;)</div><div class="line">let auth = require(&apos;../filters/authentication&apos;)</div></pre></td></tr></table></figure></p>
<p>然后将它们添加到暴露的方法中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">module.exports = function (app) &#123;</div><div class="line">// 注意添加顺序要保持一致</div><div class="line">// ---begin---</div><div class="line">    app.use(sess)</div><div class="line">    app.use(&apos;/login&apos;, loginRoutes)</div><div class="line">    app.use(&apos;/register&apos;, registerRoutes)</div><div class="line">    app.use(auth)</div><div class="line">// ---end---</div><div class="line">    app.use(&apos;/&apos;, indexRoutes)</div><div class="line">    app.use(&apos;/graphql&apos;, graphqlRoutes)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接下来,就是去实现这四个部分,先看server/filters/session.js的实现<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">module.exports = (req, res, next) =&gt; &#123;</div><div class="line">    if (!req.session) &#123;</div><div class="line">        return next(new Error(&apos;session missed.&apos;))</div><div class="line">    &#125;</div><div class="line">    next()</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>超级简单,验证一下请求里是否有session对象,没有的话,就哭.<br>然后,我们顺道把server/filters/authentication.js也实现一个简单的版本<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">module.exports = (req, res, next) =&gt; &#123;</div><div class="line">    if (req.session.user) &#123;</div><div class="line">        next()</div><div class="line">    &#125; else &#123;</div><div class="line">        res.redirect(&apos;/login&apos;)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>okay,现在我们会校验一下请求中的session对象里有没有user,没有的话,就跳转到login.<br>当然这只是先做一个简单的功能,暂且不考虑针对ajax请求所返回的数据形式.<br>接下来的工作就是实现刚才定义的两个路由,/login和/register.<br>server/routes/actions/login.js:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">let router = require(&apos;express&apos;).Router()</div><div class="line">router.get(&apos;/&apos;, (req, res) =&gt; &#123;</div><div class="line">    res.send(&#123;</div><div class="line">        title: &apos;login&apos;</div><div class="line">    &#125;)</div><div class="line">&#125;)</div><div class="line">module.exports = router</div></pre></td></tr></table></figure></p>
<p>server/routes/actions/register.js<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">let router = require(&apos;express&apos;).Router()</div><div class="line">router.get(&apos;/&apos;, (req, res) =&gt; &#123;</div><div class="line">    res.send(&#123;</div><div class="line">        title: &apos;register&apos;</div><div class="line">    &#125;)</div><div class="line">&#125;)</div><div class="line">module.exports = router</div></pre></td></tr></table></figure></p>
<p>ok,现在我们启动服务器<code>npm run debug</code><br>然后访问 <a href="http://localhost:8001/index" target="_blank" rel="external">http://localhost:8001/index</a> 会发现我们已经被redirect到了login页面</p>
<p><img src="http://upload-images.jianshu.io/upload_images/140939-c4dff4c56a0207b2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Paste_Image.png"></p>
<p>好的,现在我们的服务器按照预想的对发送到/index的请求验证了用户身份信息,发现当前会话中没有user信息,所以给我们重定向到/login.<br>接下来,我们要实现web前端的部分,来完成一个用户的登录注册功能.</p>
<h4 id="引入模板引擎-创建登录注册页"><a href="#引入模板引擎-创建登录注册页" class="headerlink" title="引入模板引擎,创建登录注册页"></a>引入模板引擎,创建登录注册页</h4><p>首先,我们要在项目的根目录创建public和src目录</p>
<ul>
<li>public 用来放置我们服务器提供的一些前端资源</li>
<li>src 是我们前端开发的源码目录<br>然后创建服务器端的视图文件夹目录</li>
<li>server/views </li>
</ul>
<p>然后,我们进入到src目录,创建名为scripts的子目录,接着在其下创建一个entry.js,该文件作为我们前端打包时的入口文件.<br>接下来我们需要安装jade模板引擎,<code>npm i --save jade</code>,然后在server.js中添加引擎</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">let path = require(&apos;path&apos;)</div><div class="line"></div><div class="line">app.set(&apos;views&apos;, path.join(__dirname, &apos;views&apos;))</div><div class="line">app.set(&apos;view engine&apos;, &apos;jade&apos;)</div><div class="line">app.use(express.static(__dirname + &apos;/../public&apos;))</div></pre></td></tr></table></figure>
<p>好的,接下来我们先完成login页面的渲染,在这之前我们要给login的路由做些小的调整,打开server/routes/actions/login.js,将原本的route.get替换成<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">router.get(&apos;/&apos;, (req, res) =&gt; &#123;</div><div class="line">    let msg = req.session.error</div><div class="line">    req.session.error = &apos;&apos;</div><div class="line">    res.render(&apos;login&apos;, &#123;</div><div class="line">        title: &apos;请登录&apos;,</div><div class="line">        error: msg</div><div class="line">    &#125;)</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p>
<p>这样我们的服务器会在接收到/login的get请求时,去调用app指定的模板渲染引擎(也就是上文的<code>app.set(&#39;view engine&#39;,&#39;jade&#39;)</code>所指定的<code>jade</code>)去渲染对应的页’login’.</p>
<p>下面,我们要去完成’login.jade’页面,创建文件<code>/server/views/login.jade</code>,<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">doctype html</div><div class="line">html</div><div class="line">  head</div><div class="line">    meta(charset=&quot;utf-8&quot;)</div><div class="line">    meta(content=&quot;width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0&quot;,name=&quot;viewport&quot;)</div><div class="line">    title= title</div><div class="line">  body.hold-transition.login-page</div><div class="line">    .container</div><div class="line">      .login-logo</div><div class="line">        a</div><div class="line">          span.text-danger.animated.bounceInDown</div><div class="line">            strong 登录</div><div class="line">      .login-box-body</div><div class="line">        form(method=&apos;post&apos;,action=&apos;/login&apos;)</div><div class="line">          p.text-red #&#123;error&#125;</div><div class="line">          .form-group.has-feedback</div><div class="line">            input.form-control(type=&apos;text&apos;,name=&apos;username&apos;,placeholder=&apos;Username&apos;)</div><div class="line">            span.glyphicon.glyphicon-user.form-control-feedback</div><div class="line">          .form-group.has-feedback</div><div class="line">            input.form-control(type=&apos;password&apos;,name=&apos;password&apos;,placeholder=&apos;Password&apos;)</div><div class="line">            span.glyphicon.glyphicon-lock.form-control-feedback</div><div class="line">          .row</div><div class="line">            .col-xs-6</div><div class="line">              button.btn.btn-success.btn-block 登录</div><div class="line">            .col-xs-6</div><div class="line">              a.btn.btn-info.btn-block.btn-register(href=&apos;/register&apos;) 还没注册?</div></pre></td></tr></table></figure></p>
<p>好的,目前为止,我们已经可以在<a href="http://localhost:8001/login地址访问到这个挫的不行的登录页了" target="_blank" rel="external">http://localhost:8001/login地址访问到这个挫的不行的登录页了</a>.</p>
<p>为了保证模板的通用性,我们可以把页面正文之外的部分抽出来,作为一个layout,那么我们需要做一些修改.首先创建<code>server/views/_layout.jade</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">doctype html</div><div class="line">html</div><div class="line">  head</div><div class="line">    title= title</div><div class="line">    meta(charset=&quot;utf-8&quot;)</div><div class="line">    meta(content=&quot;width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0&quot;,name=&quot;viewport&quot;)</div><div class="line">  block content</div></pre></td></tr></table></figure></p>
<p>然后,将我们刚才的<code>login.jade</code>调整为<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">extends _layout</div><div class="line">block content</div><div class="line">  body.hold-transition.login-page</div><div class="line">    .container</div><div class="line">      .login-logo</div><div class="line">        a</div><div class="line">          span.text-danger.animated.bounceInDown</div><div class="line">            strong 登录</div><div class="line">      .login-box-body</div><div class="line">        form(method=&apos;post&apos;,action=&apos;/login&apos;)</div><div class="line">          p.text-red #&#123;error&#125;</div><div class="line">          .form-group.has-feedback</div><div class="line">            input.form-control(type=&apos;text&apos;,name=&apos;username&apos;,placeholder=&apos;Username&apos;)</div><div class="line">            span.glyphicon.glyphicon-user.form-control-feedback</div><div class="line">          .form-group.has-feedback</div><div class="line">            input.form-control(type=&apos;password&apos;,name=&apos;password&apos;,placeholder=&apos;Password&apos;)</div><div class="line">            span.glyphicon.glyphicon-lock.form-control-feedback</div><div class="line">          .row</div><div class="line">            .col-xs-6</div><div class="line">              button.btn.btn-success.btn-block 登录</div><div class="line">            .col-xs-6</div><div class="line">              a.btn.btn-info.btn-block.btn-register(href=&apos;/register&apos;) 还没注册?</div></pre></td></tr></table></figure></p>
<p>okay,这样我们就可以在接下来专注到body部分的实现了,顺势把注册也完成吧</p>
<p>register.js 路由<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">router.get(&apos;/&apos;, (req, res) =&gt; &#123;</div><div class="line">    let msg = req.session.error</div><div class="line">    req.session.error = &apos;&apos;</div><div class="line">    res.render(&apos;register&apos;, &#123;</div><div class="line">        title: &apos;来啊,注册啊&apos;,</div><div class="line">        error: msg</div><div class="line">    &#125;)</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p>
<p>register.jade<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">extends _layout</div><div class="line">block content</div><div class="line">  body.hold-transition.login-page</div><div class="line">    .container</div><div class="line">      .login-logo</div><div class="line">        a</div><div class="line">          span.text-danger.animated.bounceInDown</div><div class="line">            strong 注册</div><div class="line">      .login-box-body</div><div class="line">        form(method=&apos;post&apos;,action=&apos;/register&apos;)</div><div class="line">          p.text-red #&#123;error&#125;</div><div class="line">          .form-group.has-feedback</div><div class="line">            input.form-control(type=&apos;text&apos;,name=&apos;username&apos;,placeholder=&apos;用户名&apos;)</div><div class="line">            span.glyphicon.glyphicon-user.form-control-feedback</div><div class="line">          .form-group.has-feedback</div><div class="line">            input.form-control(type=&apos;password&apos;,name=&apos;password&apos;,placeholder=&apos;密码&apos;)</div><div class="line">            span.glyphicon.glyphicon-lock.form-control-feedback</div><div class="line">          .form-group.has-feedback</div><div class="line">            input.form-control(type=&apos;password&apos;,name=&apos;confirmpwd&apos;,placeholder=&apos;确认密码&apos;)</div><div class="line">            span.glyphicon.glyphicon-lock.form-control-feedback</div><div class="line">          .row</div><div class="line">            .col-xs-6</div><div class="line">              button.btn.btn-success.btn-block 提交</div><div class="line">            .col-xs-6</div><div class="line">              a.btn.btn-info.btn-block.btn-register(href=&apos;/login&apos;) 已有账号?</div></pre></td></tr></table></figure></p>
<p>目前为止,我们访问 <a href="http://localhost:8001/login" target="_blank" rel="external">http://localhost:8001/login</a><br>以及 <a href="http://localhost:8001/register" target="_blank" rel="external">http://localhost:8001/register</a> 就可以看到两个挫的不行的页面了.</p>
<p>由于我们身处在这个看脸的社会,所以我希望它们在实现功能之前,能更美观一些.<br>让我们把<br><code>link(rel=&#39;stylesheet&#39;,href=&#39;//cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css&#39;)</code><br>加到<code>_layout.jade</code>页面的head中,接下来再去访问login页面,就发现帅多了!</p>
<h4 id="完成登录注册功能"><a href="#完成登录注册功能" class="headerlink" title="完成登录注册功能"></a>完成登录注册功能</h4><p>好的,上面我们完成了登录注册两个页面的基本视图,接下来就是实现真正意义上的功能.</p>
<p>不过在这之前,按照惯例,我们要安装一些东西<br><code>npm i --save babel babel-core babel-plugin-transform-decorators-legacy</code><br>然后再创建一个文件<code>server/start.js</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">require(&apos;babel-core/register&apos;)</div><div class="line">require(&apos;./server&apos;)</div></pre></td></tr></table></figure></p>
<p>接下来到package.json中做些修改:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&quot;scripts&quot;: &#123;</div><div class="line">  &quot;debug&quot;: &quot;set NODE_ENV=DEV &amp; nodemon server/start.js&quot;</div><div class="line">&#125;,</div><div class="line">&quot;babel&quot;: &#123;</div><div class="line">  &quot;plugins&quot;: [</div><div class="line">    &quot;transform-decorators-legacy&quot;</div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>okay,这样我们nodejs的服务器环境就可以支持es7的<code>decorator</code>了.</p>
<blockquote>
<p>为什么要折腾这个?<br>我们的服务器要支持PC端和移动端的访问,而且将来使用<code>react-native</code>去做移动端的时候,通信方式也是基于<code>fetch</code>这个api,即<code>http</code>通信方式.所以我们现在在做一些通用的<code>post action</code>时,就要要考虑如何能够实现多端支持.而一个我这智商能够想到的,较为优雅的,却在观众老爷们看来可能很蹩脚的解决方案就是面向切面的设计,或者说是拦截器/修饰符/decorator/AOP,你想怎么叫都行,whatever u like…</p>
</blockquote>
<p>好的,接下来,新建2个文件<br>server/dispatch/response.js<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line">let logger = require(&apos;../../framework/logger/Logger&apos;)</div><div class="line"></div><div class="line">const IS_FROM_MOBILE = function(req) &#123;</div><div class="line">    return !!req.headers[&apos;os&apos;]  // 当请求头中带有os这个值时,是我们从移动端发来的请求</div><div class="line">&#125;</div><div class="line"></div><div class="line">class ActionResult &#123;</div><div class="line">    /**</div><div class="line">     * @param &#123;boolean&#125; isSuccess 是否成功</div><div class="line">     * @param &#123;string|object|null&#125; data 附加数据</div><div class="line">     */</div><div class="line">    constructor(isSuccess, data) &#123;</div><div class="line">        this.success = isSuccess === undefined || isSuccess</div><div class="line">        this.data = data</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">module.exports = &#123;</div><div class="line">    dispatch: () =&gt; &#123;</div><div class="line">        return (target, actionName, descriptor) =&gt; &#123;</div><div class="line">            let method = descriptor.value</div><div class="line">            if (typeof target !== &apos;object&apos; || target.constructor.name === &apos;Object&apos;) &#123;</div><div class="line">                throw new ReferenceError(&apos;Dispatcher必须作用于非匿名类的实例方法&apos;)</div><div class="line">            &#125;</div><div class="line">            descriptor.value = (req, res, ...args) =&gt; &#123;</div><div class="line">                try &#123;</div><div class="line">                    let ret = method.call(target, req, res, args)</div><div class="line">                    if (!ret || !(ret instanceof ActionResult)) &#123;</div><div class="line">                        throw new Error(&apos;Dispatcher所作用的action返回值必须为ActionResult的实例&apos;)</div><div class="line">                    &#125;</div><div class="line">                    if (ret.graphql) &#123;</div><div class="line">                        res.send(&apos;it\&apos;s a graphql query&apos;)</div><div class="line">                    &#125; else &#123;</div><div class="line">                        let result = `$&#123;target.constructor.name&#125;.$&#123;actionName&#125;.$&#123;ret.success?&apos;success&apos;:&apos;fail&apos;&#125;`</div><div class="line">                        if (IS_FROM_MOBILE(req)) &#123;</div><div class="line">                            // 来自mobile的请求(暂不区分android/ios)</div><div class="line">                            res.send(&apos;it comes from mobile&apos;)</div><div class="line">                        &#125; else &#123;</div><div class="line">                            // 非mobile请求(当前视作web请求)</div><div class="line">                            switch (result) &#123;</div><div class="line">                                case &apos;loginController._post.fail&apos;:</div><div class="line">                                    req.session.error = ret.data || &apos;&apos;</div><div class="line">                                    res.redirect(&apos;/login&apos;)</div><div class="line">                                    break</div><div class="line">                                case &apos;loginController._post.success&apos;:</div><div class="line">                                    res.redirect(&apos;/index&apos;)</div><div class="line">                                    break</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125; catch (error) &#123;</div><div class="line">                    logger.error(`$&#123;target.constructor.name&#125;.$&#123;actionName&#125; occurred error: $&#123;error&#125;`)</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    ActionResult: ActionResult</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>还有一个日志记录<br>framework/logger/logger.js<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">class DevLogger &#123;</div><div class="line">    info(msg) &#123;</div><div class="line">        console.log(`$&#123;new Date().toLocaleString()&#125; - $&#123;msg&#125;`)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    warn(msg) &#123;</div><div class="line">        console.warn(`$&#123;new Date().toLocaleString()&#125; - $&#123;msg&#125;`)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    error(msg) &#123;</div><div class="line">        console.error(`$&#123;new Date().toLocaleString()&#125; - $&#123;msg&#125;`)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">class ProdLogger &#123;</div><div class="line">    // todo</div><div class="line">&#125;</div><div class="line"></div><div class="line">let logger = process.env.NODE_ENV == &apos;DEV&apos; ? new DevLogger() : new ProdLogger()</div><div class="line"></div><div class="line">module.exports = logger</div></pre></td></tr></table></figure></p>
<p>好的,准备工作完成了,下面让我们把目光放回到<code>server/routes/actions</code>目录中.</p>
<blockquote>
<p>这里说是路由,不如说是路由映射及controller的实现,如果读者觉得头晕目眩恶心反胃,不妨把routes/actions和routes/graphql里的controller部分抽离到server目录下.</p>
</blockquote>
<p>server/routes/actions/login.js修改如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">let router = require(&apos;express&apos;).Router()</div><div class="line">let bodyParser = require(&apos;body-parser&apos;)</div><div class="line">let urlencodedParser = bodyParser.urlencoded(&#123; extended: false &#125;)</div><div class="line">let &#123; dispatch, ActionResult &#125; = require(&apos;../../dispatch/response&apos;)</div><div class="line">class loginController &#123;</div><div class="line">    _get(req, res) &#123;</div><div class="line">        let msg = req.session.error</div><div class="line">        req.session.error = &apos;&apos;</div><div class="line">        res.render(&apos;login&apos;, &#123;</div><div class="line">            title: &apos;请登录&apos;,</div><div class="line">            error: msg</div><div class="line">        &#125;)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @dispatch()</div><div class="line">    _post(req, res) &#123;</div><div class="line">        return new ActionResult(true, &apos;哎哟我曹&apos;)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">let _controller = new loginController()</div><div class="line"></div><div class="line">router.get(&apos;/&apos;, _controller._get)</div><div class="line">router.post(&apos;/&apos;, urlencodedParser, _controller._post)</div><div class="line"></div><div class="line">module.exports = router</div></pre></td></tr></table></figure></p>
<p>(未完待续…)</p>

    </div>

    

    
        <div class="post-tags">
            <i class="fa fa-tags" aria-hidden="true"></i>
            <a href="/my-blog/tags/javascript-全栈/">#javascript 全栈</a>
        </div>
    

    <!-- Comments -->
    
    <div class="comments">
        


    </div>
    

</div>
        </section>

    </div>
</div>

</div>

<!-- Footer -->
<div class="push"></div>

<footer class="footer-content">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 footer-about">
                <h2>关于</h2>
                <p>
                    如果有问题欢迎提ISSUE
                </p>
            </div>
            
    <div class="col-xs-6 col-sm-6 col-md-3 col-lg-3 recent-posts">
        <h2>最近发布</h2>
        <ul>
            
            <li>
                <a class="footer-post" href="/my-blog/2016/10/01/好玩的社区/">好玩的社区</a>
            </li>
            
            <li>
                <a class="footer-post" href="/my-blog/2016/09/28/踩过的坑/">踩过的坑</a>
            </li>
            
            <li>
                <a class="footer-post" href="/my-blog/2016/09/28/工具使用/">工具使用</a>
            </li>
            
            <li>
                <a class="footer-post" href="/my-blog/2016/09/28/奇技淫巧/">奇技淫巧</a>
            </li>
            
        </ul>
    </div>



            
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <ul class="list-inline footer-social-icons">
                    
                    <li class="list-inline-item">
                        <a href="https://github.com/marsoln/my-blog">
                            <span class="footer-icon-container">
                                <i class="fa fa-github"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://twitter.com/marsoln1988">
                            <span class="footer-icon-container">
                                <i class="fa fa-twitter"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    
                    
                    
                    
                    
                    <li class="list-inline-item">
                        <a href="mailto:marsoln1988@gmail.com">
                            <span class="footer-icon-container">
                                <i class="fa fa-envelope-o"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                </ul>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <div class="footer-copyright">
                    Hexo & Alpha-Dust What A Magic! ❤ by Marsoln
                </div>
            </div>
        </div>
    </div>
</footer>

<!-- After footer scripts -->

<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Tween Max -->
<script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.5/TweenMax.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JavaScript -->
<script src="/my-blog/js/main.js"></script>

<!-- Disqus Comments -->



</body>

</html>