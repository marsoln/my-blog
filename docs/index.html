<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="Marsoln 修行札记">
    

    <!--Author-->
    
        <meta name="author" content="Marsoln">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="marsoln&#39;s blog"/>
    

    <!--Open Graph Description-->
    
        <meta property="og:description" content="Marsoln 修行札记" />
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="marsoln&#39;s blog"/>

    <!--Type page-->
    
        <meta property="og:type" content="website" />
    

    <!--Page Cover-->
    

    <meta name="twitter:card" content="summary" />
    

    <!-- Title -->
    
    <title>marsoln&#39;s blog</title>

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css" integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd" crossorigin="anonymous">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/myBlog/css/style.css">

</head>


<body>

<div class="bg-gradient"></div>
<div class="bg-pattern"></div>

<!-- Menu -->
<!--Menu Links and Overlay-->
<div class="menu-bg">
    <div class="menu-container">
        <ul>
            
            <li class="menu-item">
                <a href="/myBlog/">
                    首页
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/myBlog/archives">
                    归档
                </a>
            </li>
            
        </ul>
    </div>
</div>

<!--Hamburger Icon-->
<nav>
    <a href="#menu"></a>
</nav>

<div class="container">

    <!-- Main Content -->
    <div class="row">
    <div class="col-sm-12">

        <!--Title and Logo-->
        <header>
    <div class="logo">
        <a href="/myBlog/"><i class="logo-icon fa fa-cube" aria-hidden="true"></i></a>
        
            <h1 id="main-title" class="title">marsoln's blog</h1>
        
    </div>
</header>

        <section class="main">
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/myBlog/2016/09/28/踩过的坑/">
                踩过的坑
            </a>
        </h1>
        <div class="post-info">
            <span class="date">2016-09-28</span>
            
            
        </div>
    </div>

    
        <div class="content">
            <h1 id="浏览器"><a href="#浏览器" class="headerlink" title="浏览器"></a>浏览器</h1><h3 id="IE-系列"><a href="#IE-系列" class="headerlink" title="IE 系列"></a>IE 系列</h3><ul>
<li>IE11在跨站引用的样式文件中的url(比如字体文件路径)解析时,会将document文档的域作为当前域,而不是该样式文件的域.</li>
<li>在IE8中使用respond.js去使之支持css3媒体查询的时候,值得注意的是<strong>respond默认不会加载跨域样式资源</strong>,</li>
<li>在IE8中实现数据可视化,千万不要用基于canvas绘图的插件+excanvas,这是自寻死路.还是找找svg+vml绘图的插件吧,比如highcharts之类的.效率问题.</li>
</ul>
<h3 id="Ajax-CORS"><a href="#Ajax-CORS" class="headerlink" title="Ajax/CORS"></a>Ajax/CORS</h3><ul>
<li>XMLHttpRequest的<code>setRequestHeader</code>要在<code>open</code>后进行</li>
<li>在跨域的POST请求,需要携带cookie身份信息时,XMLHttpRequest的<code>withCredentials</code>要在<code>open</code>后,设置为<code>true</code>(对应的,服务器要有<code>Access-Control-Allow-Credentials: true</code>的responseHeader)</li>
</ul>
<h3 id="IOS-微信X5"><a href="#IOS-微信X5" class="headerlink" title="IOS 微信X5"></a>IOS 微信X5</h3><ul>
<li>不支持canvas.resetTransform()</li>
<li>不支持Array.fill</li>
<li>不支持Array.findIndex </li>
</ul>
<h3 id="Android-微信X5"><a href="#Android-微信X5" class="headerlink" title="Android 微信X5"></a>Android 微信X5</h3><ul>
<li>不支持字符串模板</li>
</ul>
<h1 id="NODEJS"><a href="#NODEJS" class="headerlink" title="NODEJS"></a>NODEJS</h1><h3 id="MSBuild-Error-MSB4132-错误"><a href="#MSBuild-Error-MSB4132-错误" class="headerlink" title="MSBuild Error MSB4132 错误"></a>MSBuild Error MSB4132 错误</h3><p>该错误是由于node-gyp默认使用2.0版本的msbuild,可能和当前机器上的msbuild版本不一致导致的.</p>
<blockquote>
<p>msbuild error msb4132 the tools version 2.0 is unrecognized. available tools versions are 4.0</p>
</blockquote>
<ul>
<li>首先检查Python安装的版本和系统变量</li>
<li>然后检查是否安装MS build tools</li>
<li>接下来卸载node-gyp(高版本的npm里node-gyp不再是独立的包 不能卸载)</li>
<li>告诉npm当前系统msbuild的版本<ul>
<li>可以设置npm全局配置 <code>npm config set msvs_version xxxx --global</code> xxxx代表版本 2012/2013/2015  </li>
<li>或者在npm的 rebuild|install 某些需要编译的包时加上msvs_version的指定设置 <code>npm install &lt;module&gt; --msvs_version=xxxx</code></li>
</ul>
</li>
<li>重装node-gyp</li>
</ul>
<h3 id="MSBuild-Error-MSB4019-错误"><a href="#MSBuild-Error-MSB4019-错误" class="headerlink" title="MSBuild Error MSB4019 错误"></a>MSBuild Error MSB4019 错误</h3><p>这个错误是由于node-gyp在build一些项目,没有找到系统配置的microsoft.cpp.default.props文件位置导致的</p>
<ul>
<li>首选,要确保已经安装了vs,譬如vs 2015(V140),如果没有安装那是找不到这个文件的,起码win10下我装了<code>vcredist_x64 2013</code>是没有的</li>
<li>其次,确保路径设置正确<ul>
<li>打开注册表确认<code>HKLM\SOFTWARE\Microsoft\MSBuild\ToolsVersions\4.0</code>路径下的<code>VCTargetsPath</code>的值为<code>$(MSBuildExtensionsPath32)\Microsoft.Cpp\v4.0\V140</code>,V140是vs2015的路径,其余版本还得视情况而定</li>
<li>也可以打开cmd,设置VCTargetsPath路径 <code>set VCTargetsPath=c:\Program Files (x86)\MSBuild\Microsoft.Cpp\v4.0\V140</code>,不过这个方式cmd关了就没用了</li>
</ul>
</li>
<li>重新 <code>npm rebuild node-sass</code></li>
</ul>
<h3 id="Babel-Gulp使用-Symbol-iterator-时编译出现错误"><a href="#Babel-Gulp使用-Symbol-iterator-时编译出现错误" class="headerlink" title="Babel-Gulp使用[Symbol.iterator]时编译出现错误"></a>Babel-Gulp使用[Symbol.iterator]时编译出现错误</h3><blockquote>
<p>npm install babel-plugin-transform-runtime</p>
</blockquote>
<p>然后在</p>
<pre><code>gulp.task(&apos;default&apos;, ()=&gt; {
  return gulp
    .src(&apos;app.js&apos;)
    .pipe(babel({
      presets: [&apos;es2015&apos;],
      plugins: [&apos;transform-runtime&apos;]
    }))
    .pipe(gulp.dest(&apos;dist&apos;))
    ;
});
</code></pre><p>但是编译完成后的文件模块的路径出现了问题</p>
<pre><code>Error: Cannot find module &apos;babel-runtime/core-js/get-iterator&apos;
    at Function.Module._resolveFilename (module.js:337:15)
    at Function.Module._load (module.js:287:25)
    at Module.require (module.js:366:17)
    at require (module.js:385:17)
    at Object.&lt;anonymous&gt; (C:\Users\Administrator\Desktop\Marsoln Licher\Lib\exampleProj\dist\app.js:3:21)
    at Module._compile (module.js:435:26)
    at Object.Module._extensions..js (module.js:442:10)
    at Module.load (module.js:356:32)
    at Function.Module._load (module.js:311:12)
    at Function.Module.runMain (module.js:467:10)

尚未有什么好的解决方法,估计是其自身的问题,babel-gulp的repo里也有对应的[ISSUE](https://github.com/babel/gulp-babel/issues/50 &quot;Cannot find module &apos;babel-runtime/regenerator&apos;&quot;)
</code></pre><h1 id="ELM"><a href="#ELM" class="headerlink" title="ELM"></a>ELM</h1><h3 id="windows环境下-elm-package-install-elm-make-出现错误permission-denied"><a href="#windows环境下-elm-package-install-elm-make-出现错误permission-denied" class="headerlink" title="windows环境下 elm-package install/elm-make 出现错误permission denied"></a>windows环境下 elm-package install/elm-make 出现错误permission denied</h3><pre><code>elm-make: elm-lang-core-5204441: MoveFileEx &quot;elm-lang-core-5204441&quot; &quot;2.1.0&quot;: permission denied (Access is denied.)
</code></pre><p>详情参见 <a href="https://github.com/elm-lang/elm-platform/issues/81">ISSUE</a><br>分析错误,发现是elm包管理器在下载pkg之后需要创建一个版本号然后将对应的文件移动到其目录下,这个动作在windows平台上有安全问题,所以操作失败.<br>临时解决方法是手动移动<code>elm-lang-core-5204441</code>文件夹到<code>elm-stuff/packages/elm-lang/core/</code>目录下,重命名目录名称为<code>2.1.0</code></p>
<h1 id="REACT-NATIVE"><a href="#REACT-NATIVE" class="headerlink" title="REACT-NATIVE"></a>REACT-NATIVE</h1><h3 id="windows环境下-android开发"><a href="#windows环境下-android开发" class="headerlink" title="windows环境下 android开发"></a>windows环境下 android开发</h3><pre><code>- socket.io 出现引用错误,初步估计是因为socket.io和react-native都是用webpack打包,所以查找引用目录出现了问题,
于是将socket.io.js(打包后的文件)作为一个单独模块添加到项目里,
然后报了一些navigator的错误(因为根据浏览器的userAgent判断环境),无脑的去掉这些地方就能用了
</code></pre>
        </div>
    

</div>
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/myBlog/2016/09/28/工具使用/">
                工具使用
            </a>
        </h1>
        <div class="post-info">
            <span class="date">2016-09-28</span>
            
            
        </div>
    </div>

    
        <div class="content">
            <h1 id="Git"><a href="#Git" class="headerlink" title="Git"></a>Git</h1><h3 id="生成ssh"><a href="#生成ssh" class="headerlink" title="生成ssh"></a>生成ssh</h3><pre><code>- 配置全局设置 `git config --global user.name &quot;username&quot;` `git confgi --global user.email &quot;example@xxx.com&quot;`
- 生成ssh `ssh-keygen -t rsa -C &quot;example@xxx.com&quot;` 会在C:\User\xxx目录下生成.ssh目录
- 将生成的.ssh目录中的id_rsa.pub的内容添加到gitlab/github的个人账户的ssh-key
- 验证 ssh 是否添加成功 `ssh git@github.com`
</code></pre><h3 id="解决git-clone时文件目录过长的方法"><a href="#解决git-clone时文件目录过长的方法" class="headerlink" title="解决git clone时文件目录过长的方法"></a>解决git clone时文件目录过长的方法</h3><pre><code>修改git设置 `git config --system core.longpaths true`
</code></pre><h1 id="VS-CODE"><a href="#VS-CODE" class="headerlink" title="VS CODE"></a>VS CODE</h1><h3 id="配置代码段"><a href="#配置代码段" class="headerlink" title="配置代码段"></a>配置代码段</h3><ul>
<li><code>ctrl + p</code> 打开quick open</li>
<li>输入 <code>&gt;snippets</code> 回车</li>
<li>进入到代码段语言选择输入栏,输入你想编辑的代码段使用的语言,譬如javascript,回车</li>
<li>打开一个名称为javascript.json的配置文件</li>
<li><p>假设我们要一个控制台打印的代码段,缩写为<code>_cl</code>,则需要添加如下配置</p>
<pre><code>&quot;Console log&quot;: {    // 代码段的名称
    &quot;prefix&quot;: &quot;_cl&quot;,    // 触发代码段的缩写
    &quot;body&quot;: [
        &quot;console.log(&apos;$1&apos;)&quot;,    // 代码段的第一行 $1表示第一个变量
        &quot;$2&quot;    // 代码段的第二行
    ],
    &quot;description&quot;: &quot;输出到控制台&quot; // 代码段的描述
}
</code></pre></li>
<li><p>保存即生效,当然只能在你指定的语言中生效</p>
</li>
</ul>
<h1 id="GULP-WEBPACK"><a href="#GULP-WEBPACK" class="headerlink" title="GULP/WEBPACK"></a>GULP/WEBPACK</h1><h3 id="多入口打包ES6模块化文件"><a href="#多入口打包ES6模块化文件" class="headerlink" title="多入口打包ES6模块化文件"></a>多入口打包ES6模块化文件</h3><pre><code>var gulp = require(&apos;gulp&apos;)
var webpack = require(&apos;webpack-stream&apos;)
var uglify = require(&apos;gulp-uglify&apos;)
var through = require(&apos;through2&apos;)

gulp.task(&apos;packagedScripts&apos;, () =&gt; {
    gulp.src(&apos;./src/scripts/entrances/**/*&apos;)
        .pipe(through.obj(function (file, enc, cb) {
            var __filename = file.path.split(&apos;\\&apos;).reverse()[0]
            gulp.src(file.path)
                .pipe(webpack({
                    output: {
                        filename: __filename
                    },
                    module: {
                        loaders: [
                            {
                                test: /\.js$/,
                                exclude: /node_modules/,
                                loader: &apos;babel&apos;,
                                query: {
                                    presets: [&apos;es2015&apos;]
                                }
                            }
                        ]
                    }
                }))
                .pipe(uglify())
                .pipe(gulp.dest(&apos;./src/scripts/packaged&apos;))  // 输出到指定目录
            cb()
        }))
})
</code></pre><h3 id="gulp-rev-all-gulp-filter-生成文件hash值-并替换对其的引用"><a href="#gulp-rev-all-gulp-filter-生成文件hash值-并替换对其的引用" class="headerlink" title="gulp-rev-all,gulp-filter 生成文件hash值 并替换对其的引用"></a>gulp-rev-all,gulp-filter 生成文件hash值 并替换对其的引用</h3><pre><code>var gulp = require(&apos;gulp&apos;)
var sass = require(&apos;gulp-sass&apos;)
var imagemin = require(&apos;gulp-imagemin&apos;)
var uglify = require(&apos;gulp-uglify&apos;)
var cssMinify = require(&apos;gulp-minify-css&apos;)
var RevAll = require(&apos;gulp-rev-all&apos;)
var filter = require(&apos;gulp-filter&apos;)

var buildFunc = () =&gt; {
    var jsFilter = filter(&apos;**/*.js&apos;)
    var htmlFilter = filter(&apos;**/*.html&apos;)
    var cssFilter = filter(&apos;**/*.css&apos;)
    var picFilter = filter([&apos;**/*.jpg&apos;, &apos;**/*.png&apos;])

    var revAll = RevAll({
        dontGlobal: [&apos;.scss&apos;],
        dontRenameFile: [&apos;.html&apos;],
        dontSearchFile: [&apos;.css&apos;],
        transformPath: function(rev) {
            return rev
                .replace(&apos;scripts/&apos;, &apos;dist/scripts/&apos;)
                .replace(&apos;style/&apos;, &apos;dist/style/&apos;)
                .replace(&apos;images/&apos;, &apos;dist/images/&apos;)
        }
    })

    var v = gulp.src(&apos;src/**/*&apos;)
        .pipe(revAll.revision());

    // 压缩js
    v.pipe(jsFilter)
        .pipe(uglify())
        .pipe(gulp.dest(&apos;./dist&apos;));

    // 压缩css
    v.pipe(cssFilter)
        .pipe(cssMinify())
        .pipe(gulp.dest(&apos;./dist&apos;));

    // 压缩图片
    v.pipe(picFilter)
        .pipe(imagemin())
        .pipe(gulp.dest(&apos;./dist&apos;))

    // 生成index.html
    v.pipe(htmlFilter)
        .pipe(gulp.dest(&apos;./&apos;));
}
</code></pre>
        </div>
    

</div>
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/myBlog/2016/09/28/奇技淫巧/">
                奇技淫巧
            </a>
        </h1>
        <div class="post-info">
            <span class="date">2016-09-28</span>
            
            
        </div>
    </div>

    
        <div class="content">
            <h3 id="generator-生成i内的-fibonacci数组"><a href="#generator-生成i内的-fibonacci数组" class="headerlink" title="generator 生成i内的 fibonacci数组"></a>generator 生成i内的 fibonacci数组</h3><pre><code>let i = 1000;
[...(function(limit){ 
    return function* (){
        let [prev, curr] = [0,1]
        while(prev + curr &lt; limit){
            [prev, curr] = [curr, prev + curr]
            yield curr
        }
    }
})(i)()]
</code></pre><h3 id="求反运算配合indexOf的运用"><a href="#求反运算配合indexOf的运用" class="headerlink" title="求反运算配合indexOf的运用"></a>求反运算配合indexOf的运用</h3><pre><code>Array.prototype.has = String.prototype.has = function(sth){
    return !!~this.indexOf(sth)
}

&apos;csa&apos;.has(&apos;a&apos;);   // true
[1,2,3].has(&apos;1&apos;); // false
[1,2,3].has(3);  // true
</code></pre><h3 id="不需要中间变量-交换两个值类型变量的值得装逼进阶"><a href="#不需要中间变量-交换两个值类型变量的值得装逼进阶" class="headerlink" title="不需要中间变量,交换两个值类型变量的值得装逼进阶"></a>不需要中间变量,交换两个值类型变量的值得装逼进阶</h3><pre><code>let [a,b]=[1,2]
// 普通青年
a=a+b
b=a-b
a=a-b
// 文艺青年
a=a^b
b=a^b
a=a^b
// 进阶演化
a^=b
b^=a
a^=b
-----
b^=a^=b
a^=b
-----
a=(b^=a^=b)^a
-----
// 究极装逼方案
b^=a^(a=b)
</code></pre><p>为什么会这样呢?<br>因为行内的赋值写法一开始就把右侧变量的值确定下来了<br>也就是说 <code>b^=a^(a=b)</code><br>等价于 <code>b=b^a^(a=b)</code><br>等价于 <code>b=2^1^(a=2)</code><br>等价于 <code>a=2;b=2^1^2</code> – <code>a=2;b=1</code><br>也就解释了 为什么<code>a^=b^=a^=b</code>是错误的<br>因为其等价于<code>a=a^(b=b^(a=a^b))</code><br><code>a=1^(b=2^(a=1^2))</code>   // a=1,b=2<br><code>a=1^(b=2^(a=3))</code> // a被赋值为3,b=2<br><code>a=1^(b=2^3)</code>  // a=3,b=2<br><code>a=1^(b=1)</code>  // a=3,b被赋值为1<br><code>a=1^1</code> // a=1,b=1<br><code>a=0</code> // a被赋值为0,b=1  </p>
<h3 id="一些数组操作的技巧-效率据说会高一些"><a href="#一些数组操作的技巧-效率据说会高一些" class="headerlink" title="一些数组操作的技巧,效率据说会高一些"></a>一些数组操作的技巧,效率据说会高一些</h3><pre><code>// 譬如说
let arr = []
arr[arr.length] = 1 // arr.push(1)
[1].concat(arr) // arr.unshift(1)

// 比如将一个数组的对象转换为数值类型
let arr1 = [&apos;1&apos;,2,&apos;3&apos;]
arr1 = arr1.map(v =&gt; +v)

// 比如函数接收一个数值或者一组数值作为参数,也有可能不传
function(arrOrValue){
    let _arr= [].concat(arr || [])
}
</code></pre>
        </div>
    

</div>
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/myBlog/2016/09/27/jsFullStackSeries/03/">
                javascript全栈应用实践之路 (服务器搭建篇 二)
            </a>
        </h1>
        <div class="post-info">
            <span class="date">2016-09-27</span>
            
            
        </div>
    </div>

    
        <div class="content">
            <h4 id="剧情概要"><a href="#剧情概要" class="headerlink" title="剧情概要"></a>剧情概要</h4><p>上一集,我们一起完成了一个简单的服务器 – 提供了/index 根目录的路由,/graphql 数据服务路由并且创建了一个用户模型.<br>在这一集,我们将要完成注册登录和身份验证的基本功能,并且完成对应web端的部分.</p>
<h4 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h4><p>开始撸码之前,让我们先思考两个问题:</p>
<ul>
<li>身份验证的原理是什么</li>
<li>身份验证应该在作用于什么场景</li>
</ul>
<p>可惜我并没有教科书式的答案,只有一些自己的理解:</p>
<p>首先,我认为<strong>身份验证的机制应该是在用户通过一些行为确定身份之后,携带一个自己身份的标识信息,并且可以被服务器端所认可,其必须具有唯一性</strong>,说白了就是,你登录之后,服务器为你生成一个唯一标识,你只要每次请求的时候都带着就可以了.</p>
<p>然后,其作用的场景必然是非匿名场景,譬如<strong>对于大多数数据进行Create/Update/Delete之类的操作(甚至某些敏感数据的Read操作)需要明确你的身份的时候</strong>,这样的场景就需要身份验证.</p>
<p>好,带着这个独创的结论,我们就开始实现一个authentication吧!</p>
<h4 id="先实现简单的路由和filter"><a href="#先实现简单的路由和filter" class="headerlink" title="先实现简单的路由和filter"></a>先实现简单的路由和filter</h4><p>让我们找到并打开server/routes/Initialize.js,做一些小小的改动,添加两个路由,对应的就是我们未来的登录和注册功能<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">let loginRoutes = require(&apos;./actions/login&apos;)</div><div class="line">let registerRoutes = require(&apos;./actions/register&apos;)</div></pre></td></tr></table></figure></p>
<p>然后,再加上两个filter,sess是我们校验session的一个过滤器,auth顾名思义,就是身份验证<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">let sess = require(&apos;../filters/session&apos;)</div><div class="line">let auth = require(&apos;../filters/authentication&apos;)</div></pre></td></tr></table></figure></p>
<p>然后将它们添加到暴露的方法中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">module.exports = function (app) &#123;</div><div class="line">// 注意添加顺序要保持一致</div><div class="line">// ---begin---</div><div class="line">    app.use(sess)</div><div class="line">    app.use(&apos;/login&apos;, loginRoutes)</div><div class="line">    app.use(&apos;/register&apos;, registerRoutes)</div><div class="line">    app.use(auth)</div><div class="line">// ---end---</div><div class="line">    app.use(&apos;/&apos;, indexRoutes)</div><div class="line">    app.use(&apos;/graphql&apos;, graphqlRoutes)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接下来,就是去实现这四个部分,先看server/filters/session.js的实现<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">module.exports = (req, res, next) =&gt; &#123;</div><div class="line">    if (!req.session) &#123;</div><div class="line">        return next(new Error(&apos;session missed.&apos;))</div><div class="line">    &#125;</div><div class="line">    next()</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>超级简单,验证一下请求里是否有session对象,没有的话,就哭.<br>然后,我们顺道把server/filters/authentication.js也实现一个简单的版本<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">module.exports = (req, res, next) =&gt; &#123;</div><div class="line">    if (req.session.user) &#123;</div><div class="line">        next()</div><div class="line">    &#125; else &#123;</div><div class="line">        res.redirect(&apos;/login&apos;)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>okay,现在我们会校验一下请求中的session对象里有没有user,没有的话,就跳转到login.<br>当然这只是先做一个简单的功能,暂且不考虑针对ajax请求所返回的数据形式.<br>接下来的工作就是实现刚才定义的两个路由,/login和/register.<br>server/routes/actions/login.js:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">let router = require(&apos;express&apos;).Router()</div><div class="line">router.get(&apos;/&apos;, (req, res) =&gt; &#123;</div><div class="line">    res.send(&#123;</div><div class="line">        title: &apos;login&apos;</div><div class="line">    &#125;)</div><div class="line">&#125;)</div><div class="line">module.exports = router</div></pre></td></tr></table></figure></p>
<p>server/routes/actions/register.js<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">let router = require(&apos;express&apos;).Router()</div><div class="line">router.get(&apos;/&apos;, (req, res) =&gt; &#123;</div><div class="line">    res.send(&#123;</div><div class="line">        title: &apos;register&apos;</div><div class="line">    &#125;)</div><div class="line">&#125;)</div><div class="line">module.exports = router</div></pre></td></tr></table></figure></p>
<p>ok,现在我们启动服务器<code>npm run debug</code><br>然后访问 <a href="http://localhost:8001/index" target="_blank" rel="external">http://localhost:8001/index</a> 会发现我们已经被redirect到了login页面</p>
<p><img src="http://upload-images.jianshu.io/upload_images/140939-c4dff4c56a0207b2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Paste_Image.png"></p>
<p>好的,现在我们的服务器按照预想的对发送到/index的请求验证了用户身份信息,发现当前会话中没有user信息,所以给我们重定向到/login.<br>接下来,我们要实现web前端的部分,来完成一个用户的登录注册功能.</p>
<h4 id="引入模板引擎-创建登录注册页"><a href="#引入模板引擎-创建登录注册页" class="headerlink" title="引入模板引擎,创建登录注册页"></a>引入模板引擎,创建登录注册页</h4><p>首先,我们要在项目的根目录创建public和src目录</p>
<ul>
<li>public 用来放置我们服务器提供的一些前端资源</li>
<li>src 是我们前端开发的源码目录<br>然后创建服务器端的视图文件夹目录</li>
<li>server/views </li>
</ul>
<p>然后,我们进入到src目录,创建名为scripts的子目录,接着在其下创建一个entry.js,该文件作为我们前端打包时的入口文件.<br>接下来我们需要安装jade模板引擎,<code>npm i --save jade</code>,然后在server.js中添加引擎</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">let path = require(&apos;path&apos;)</div><div class="line"></div><div class="line">app.set(&apos;views&apos;, path.join(__dirname, &apos;views&apos;))</div><div class="line">app.set(&apos;view engine&apos;, &apos;jade&apos;)</div><div class="line">app.use(express.static(__dirname + &apos;/../public&apos;))</div></pre></td></tr></table></figure>
<p>好的,接下来我们先完成login页面的渲染,在这之前我们要给login的路由做些小的调整,打开server/routes/actions/login.js,将原本的route.get替换成<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">router.get(&apos;/&apos;, (req, res) =&gt; &#123;</div><div class="line">    let msg = req.session.error</div><div class="line">    req.session.error = &apos;&apos;</div><div class="line">    res.render(&apos;login&apos;, &#123;</div><div class="line">        title: &apos;请登录&apos;,</div><div class="line">        error: msg</div><div class="line">    &#125;)</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p>
<p>这样我们的服务器会在接收到/login的get请求时,去调用app指定的模板渲染引擎(也就是上文的<code>app.set(&#39;view engine&#39;,&#39;jade&#39;)</code>所指定的<code>jade</code>)去渲染对应的页’login’.</p>
<p>下面,我们要去完成’login.jade’页面,创建文件<code>/server/views/login.jade</code>,<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">doctype html</div><div class="line">html</div><div class="line">  head</div><div class="line">    meta(charset=&quot;utf-8&quot;)</div><div class="line">    meta(content=&quot;width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0&quot;,name=&quot;viewport&quot;)</div><div class="line">    title= title</div><div class="line">  body.hold-transition.login-page</div><div class="line">    .container</div><div class="line">      .login-logo</div><div class="line">        a</div><div class="line">          span.text-danger.animated.bounceInDown</div><div class="line">            strong 登录</div><div class="line">      .login-box-body</div><div class="line">        form(method=&apos;post&apos;,action=&apos;/login&apos;)</div><div class="line">          p.text-red #&#123;error&#125;</div><div class="line">          .form-group.has-feedback</div><div class="line">            input.form-control(type=&apos;text&apos;,name=&apos;username&apos;,placeholder=&apos;Username&apos;)</div><div class="line">            span.glyphicon.glyphicon-user.form-control-feedback</div><div class="line">          .form-group.has-feedback</div><div class="line">            input.form-control(type=&apos;password&apos;,name=&apos;password&apos;,placeholder=&apos;Password&apos;)</div><div class="line">            span.glyphicon.glyphicon-lock.form-control-feedback</div><div class="line">          .row</div><div class="line">            .col-xs-6</div><div class="line">              button.btn.btn-success.btn-block 登录</div><div class="line">            .col-xs-6</div><div class="line">              a.btn.btn-info.btn-block.btn-register(href=&apos;/register&apos;) 还没注册?</div></pre></td></tr></table></figure></p>
<p>好的,目前为止,我们已经可以在<a href="http://localhost:8001/login地址访问到这个挫的不行的登录页了" target="_blank" rel="external">http://localhost:8001/login地址访问到这个挫的不行的登录页了</a>.</p>
<p>为了保证模板的通用性,我们可以把页面正文之外的部分抽出来,作为一个layout,那么我们需要做一些修改.首先创建<code>server/views/_layout.jade</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">doctype html</div><div class="line">html</div><div class="line">  head</div><div class="line">    title= title</div><div class="line">    meta(charset=&quot;utf-8&quot;)</div><div class="line">    meta(content=&quot;width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0&quot;,name=&quot;viewport&quot;)</div><div class="line">  block content</div></pre></td></tr></table></figure></p>
<p>然后,将我们刚才的<code>login.jade</code>调整为<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">extends _layout</div><div class="line">block content</div><div class="line">  body.hold-transition.login-page</div><div class="line">    .container</div><div class="line">      .login-logo</div><div class="line">        a</div><div class="line">          span.text-danger.animated.bounceInDown</div><div class="line">            strong 登录</div><div class="line">      .login-box-body</div><div class="line">        form(method=&apos;post&apos;,action=&apos;/login&apos;)</div><div class="line">          p.text-red #&#123;error&#125;</div><div class="line">          .form-group.has-feedback</div><div class="line">            input.form-control(type=&apos;text&apos;,name=&apos;username&apos;,placeholder=&apos;Username&apos;)</div><div class="line">            span.glyphicon.glyphicon-user.form-control-feedback</div><div class="line">          .form-group.has-feedback</div><div class="line">            input.form-control(type=&apos;password&apos;,name=&apos;password&apos;,placeholder=&apos;Password&apos;)</div><div class="line">            span.glyphicon.glyphicon-lock.form-control-feedback</div><div class="line">          .row</div><div class="line">            .col-xs-6</div><div class="line">              button.btn.btn-success.btn-block 登录</div><div class="line">            .col-xs-6</div><div class="line">              a.btn.btn-info.btn-block.btn-register(href=&apos;/register&apos;) 还没注册?</div></pre></td></tr></table></figure></p>
<p>okay,这样我们就可以在接下来专注到body部分的实现了,顺势把注册也完成吧</p>
<p>register.js 路由<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">router.get(&apos;/&apos;, (req, res) =&gt; &#123;</div><div class="line">    let msg = req.session.error</div><div class="line">    req.session.error = &apos;&apos;</div><div class="line">    res.render(&apos;register&apos;, &#123;</div><div class="line">        title: &apos;来啊,注册啊&apos;,</div><div class="line">        error: msg</div><div class="line">    &#125;)</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p>
<p>register.jade<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">extends _layout</div><div class="line">block content</div><div class="line">  body.hold-transition.login-page</div><div class="line">    .container</div><div class="line">      .login-logo</div><div class="line">        a</div><div class="line">          span.text-danger.animated.bounceInDown</div><div class="line">            strong 注册</div><div class="line">      .login-box-body</div><div class="line">        form(method=&apos;post&apos;,action=&apos;/register&apos;)</div><div class="line">          p.text-red #&#123;error&#125;</div><div class="line">          .form-group.has-feedback</div><div class="line">            input.form-control(type=&apos;text&apos;,name=&apos;username&apos;,placeholder=&apos;用户名&apos;)</div><div class="line">            span.glyphicon.glyphicon-user.form-control-feedback</div><div class="line">          .form-group.has-feedback</div><div class="line">            input.form-control(type=&apos;password&apos;,name=&apos;password&apos;,placeholder=&apos;密码&apos;)</div><div class="line">            span.glyphicon.glyphicon-lock.form-control-feedback</div><div class="line">          .form-group.has-feedback</div><div class="line">            input.form-control(type=&apos;password&apos;,name=&apos;confirmpwd&apos;,placeholder=&apos;确认密码&apos;)</div><div class="line">            span.glyphicon.glyphicon-lock.form-control-feedback</div><div class="line">          .row</div><div class="line">            .col-xs-6</div><div class="line">              button.btn.btn-success.btn-block 提交</div><div class="line">            .col-xs-6</div><div class="line">              a.btn.btn-info.btn-block.btn-register(href=&apos;/login&apos;) 已有账号?</div></pre></td></tr></table></figure></p>
<p>目前为止,我们访问 <a href="http://localhost:8001/login" target="_blank" rel="external">http://localhost:8001/login</a><br>以及 <a href="http://localhost:8001/register" target="_blank" rel="external">http://localhost:8001/register</a> 就可以看到两个挫的不行的页面了.</p>
<p>由于我们身处在这个看脸的社会,所以我希望它们在实现功能之前,能更美观一些.<br>让我们把<br><code>link(rel=&#39;stylesheet&#39;,href=&#39;//cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css&#39;)</code><br>加到<code>_layout.jade</code>页面的head中,接下来再去访问login页面,就发现帅多了!</p>
<h4 id="完成登录注册功能"><a href="#完成登录注册功能" class="headerlink" title="完成登录注册功能"></a>完成登录注册功能</h4><p>好的,上面我们完成了登录注册两个页面的基本视图,接下来就是实现真正意义上的功能.</p>
<p>不过在这之前,按照惯例,我们要安装一些东西<br><code>npm i --save babel babel-core babel-plugin-transform-decorators-legacy</code><br>然后再创建一个文件<code>server/start.js</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">require(&apos;babel-core/register&apos;)</div><div class="line">require(&apos;./server&apos;)</div></pre></td></tr></table></figure></p>
<p>接下来到package.json中做些修改:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&quot;scripts&quot;: &#123;</div><div class="line">  &quot;debug&quot;: &quot;set NODE_ENV=DEV &amp; nodemon server/start.js&quot;</div><div class="line">&#125;,</div><div class="line">&quot;babel&quot;: &#123;</div><div class="line">  &quot;plugins&quot;: [</div><div class="line">    &quot;transform-decorators-legacy&quot;</div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>okay,这样我们nodejs的服务器环境就可以支持es7的<code>decorator</code>了.</p>
<blockquote>
<p>为什么要折腾这个?<br>我们的服务器要支持PC端和移动端的访问,而且将来使用<code>react-native</code>去做移动端的时候,通信方式也是基于<code>fetch</code>这个api,即<code>http</code>通信方式.所以我们现在在做一些通用的<code>post action</code>时,就要要考虑如何能够实现多端支持.而一个我这智商能够想到的,较为优雅的,却在观众老爷们看来可能很蹩脚的解决方案就是面向切面的设计,或者说是拦截器/修饰符/decorator/AOP,你想怎么叫都行,whatever u like…</p>
</blockquote>
<p>好的,接下来,新建2个文件<br>server/dispatch/response.js<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line">let logger = require(&apos;../../framework/logger/Logger&apos;)</div><div class="line"></div><div class="line">const IS_FROM_MOBILE = function(req) &#123;</div><div class="line">    return !!req.headers[&apos;os&apos;]  // 当请求头中带有os这个值时,是我们从移动端发来的请求</div><div class="line">&#125;</div><div class="line"></div><div class="line">class ActionResult &#123;</div><div class="line">    /**</div><div class="line">     * @param &#123;boolean&#125; isSuccess 是否成功</div><div class="line">     * @param &#123;string|object|null&#125; data 附加数据</div><div class="line">     */</div><div class="line">    constructor(isSuccess, data) &#123;</div><div class="line">        this.success = isSuccess === undefined || isSuccess</div><div class="line">        this.data = data</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">module.exports = &#123;</div><div class="line">    dispatch: () =&gt; &#123;</div><div class="line">        return (target, actionName, descriptor) =&gt; &#123;</div><div class="line">            let method = descriptor.value</div><div class="line">            if (typeof target !== &apos;object&apos; || target.constructor.name === &apos;Object&apos;) &#123;</div><div class="line">                throw new ReferenceError(&apos;Dispatcher必须作用于非匿名类的实例方法&apos;)</div><div class="line">            &#125;</div><div class="line">            descriptor.value = (req, res, ...args) =&gt; &#123;</div><div class="line">                try &#123;</div><div class="line">                    let ret = method.call(target, req, res, args)</div><div class="line">                    if (!ret || !(ret instanceof ActionResult)) &#123;</div><div class="line">                        throw new Error(&apos;Dispatcher所作用的action返回值必须为ActionResult的实例&apos;)</div><div class="line">                    &#125;</div><div class="line">                    if (ret.graphql) &#123;</div><div class="line">                        res.send(&apos;it\&apos;s a graphql query&apos;)</div><div class="line">                    &#125; else &#123;</div><div class="line">                        let result = `$&#123;target.constructor.name&#125;.$&#123;actionName&#125;.$&#123;ret.success?&apos;success&apos;:&apos;fail&apos;&#125;`</div><div class="line">                        if (IS_FROM_MOBILE(req)) &#123;</div><div class="line">                            // 来自mobile的请求(暂不区分android/ios)</div><div class="line">                            res.send(&apos;it comes from mobile&apos;)</div><div class="line">                        &#125; else &#123;</div><div class="line">                            // 非mobile请求(当前视作web请求)</div><div class="line">                            switch (result) &#123;</div><div class="line">                                case &apos;loginController._post.fail&apos;:</div><div class="line">                                    req.session.error = ret.data || &apos;&apos;</div><div class="line">                                    res.redirect(&apos;/login&apos;)</div><div class="line">                                    break</div><div class="line">                                case &apos;loginController._post.success&apos;:</div><div class="line">                                    res.redirect(&apos;/index&apos;)</div><div class="line">                                    break</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125; catch (error) &#123;</div><div class="line">                    logger.error(`$&#123;target.constructor.name&#125;.$&#123;actionName&#125; occurred error: $&#123;error&#125;`)</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    ActionResult: ActionResult</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>还有一个日志记录<br>framework/logger/logger.js<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">class DevLogger &#123;</div><div class="line">    info(msg) &#123;</div><div class="line">        console.log(`$&#123;new Date().toLocaleString()&#125; - $&#123;msg&#125;`)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    warn(msg) &#123;</div><div class="line">        console.warn(`$&#123;new Date().toLocaleString()&#125; - $&#123;msg&#125;`)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    error(msg) &#123;</div><div class="line">        console.error(`$&#123;new Date().toLocaleString()&#125; - $&#123;msg&#125;`)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">class ProdLogger &#123;</div><div class="line">    // todo</div><div class="line">&#125;</div><div class="line"></div><div class="line">let logger = process.env.NODE_ENV == &apos;DEV&apos; ? new DevLogger() : new ProdLogger()</div><div class="line"></div><div class="line">module.exports = logger</div></pre></td></tr></table></figure></p>
<p>好的,准备工作完成了,下面让我们把目光放回到<code>server/routes/actions</code>目录中.</p>
<blockquote>
<p>这里说是路由,不如说是路由映射及controller的实现,如果读者觉得头晕目眩恶心反胃,不妨把routes/actions和routes/graphql里的controller部分抽离到server目录下.</p>
</blockquote>
<p>server/routes/actions/login.js修改如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">let router = require(&apos;express&apos;).Router()</div><div class="line">let bodyParser = require(&apos;body-parser&apos;)</div><div class="line">let urlencodedParser = bodyParser.urlencoded(&#123; extended: false &#125;)</div><div class="line">let &#123; dispatch, ActionResult &#125; = require(&apos;../../dispatch/response&apos;)</div><div class="line">class loginController &#123;</div><div class="line">    _get(req, res) &#123;</div><div class="line">        let msg = req.session.error</div><div class="line">        req.session.error = &apos;&apos;</div><div class="line">        res.render(&apos;login&apos;, &#123;</div><div class="line">            title: &apos;请登录&apos;,</div><div class="line">            error: msg</div><div class="line">        &#125;)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @dispatch()</div><div class="line">    _post(req, res) &#123;</div><div class="line">        return new ActionResult(true, &apos;哎哟我曹&apos;)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">let _controller = new loginController()</div><div class="line"></div><div class="line">router.get(&apos;/&apos;, _controller._get)</div><div class="line">router.post(&apos;/&apos;, urlencodedParser, _controller._post)</div><div class="line"></div><div class="line">module.exports = router</div></pre></td></tr></table></figure></p>
<p>(未完待续…)</p>

        </div>
    

</div>
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/myBlog/2016/09/27/jsFullStackSeries/02/">
                javascript全栈应用实践之路 (服务器搭建篇 一)
            </a>
        </h1>
        <div class="post-info">
            <span class="date">2016-09-27</span>
            
            
        </div>
    </div>

    
        <div class="content">
            <h4 id="软件环境"><a href="#软件环境" class="headerlink" title="软件环境"></a>软件环境</h4><p>首先,需要安装一些必要的软件 </p>
<ul>
<li><a href="https://nodejs.org/zh-cn/" target="_blank" rel="external">nodejs(建议最新的6+) </a></li>
<li><a href="https://www.mongodb.com/download-center#community" target="_blank" rel="external">mongodb</a></li>
<li><a href="https://github.com/ServiceStack/redis-windows">redis(windows)</a></li>
</ul>
<p>请按照官方教程下载,然后无脑下一步下一步至全部安装完成.<br>当然<strong>mongodb在注册成系统服务</strong>以及<strong>windows系统下redis服务启动</strong>的时候可能会遇到各种小问题,但是网上有很多的教程和解决方案,我就不再赘述…</p>
<p>…了吧?</p>
<blockquote>
<p><strong>用管理员身份打开cmd</strong> cd mongoDB的bin目录(必须留在该目录)<br>mkdir xxx  创建目录用于存放数据库文件<br>执行指令(注意logpath指向<strong>文件</strong> dbpath指向<strong>目录</strong> 都是绝对路径)<br><code>mongod --install --serviceName &#39;这个服务的名称&#39; --serviceDisplayName &#39;这个服务显示的名称&#39; --logpath D:/dbfiles/logs/day-one.log --dbpath D:/dbfiles/databases/ --directoryperdb</code><br>directoryperdb 每个数据库独立目录</p>
</blockquote>
<p>接下来,我们要先创建自己的服务器端.</p>
<h4 id="来吧-Server"><a href="#来吧-Server" class="headerlink" title="来吧,Server!"></a>来吧,Server!</h4><p> 创建一个空的文件夹 MyServer<br><code>cd myserver &amp; npm init</code><br>一路回车之后,再安装几个依赖<br><code>npm i --save express express-session express-graphql graphql redis connect-redis mongoose nodemon body-parser properties-reader</code></p>
<p><strong>然后你可以先去睡几个小时,装完之后让你女朋友叫醒你</strong></p>
<p>哈哈哈,我开玩笑的<br>…<br>..<br>.<br>程序员<strong>怎么可能</strong>有女朋友!!! (╯‵□′)╯︵┻━┻</p>
<p>装完之后,我们就可以规划一个比较合理的目录了,这次我们只打算做服务器端的部分,所以我们创建三个目录:<code>mkdir server framework core</code></p>
<ul>
<li>framework 业务无关的公共的组件 譬如加密等</li>
<li>core 业务相关的公共组件  譬如数据模型等</li>
<li>server 服务器文件 譬如路由 各种及filter等</li>
</ul>
<p>接下来,我们在进入server目录创建server.js:<code>cd server &amp; touch server.js</code> (cmd下的指令是<code>cd server &amp; cd .&gt;server.js</code> 下文将不再赘述)</p>
<p>OK,现在我们在编辑器中打开server.js<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">let propReader = require(&apos;properties-reader&apos;)(&apos;server.properties&apos;)</div><div class="line">let express = require(&apos;express&apos;)</div><div class="line">let app = express()</div><div class="line">let server = require(&apos;http&apos;).createServer(app)</div><div class="line">let session = require(&apos;../framework/redis/session&apos;)</div><div class="line">let bodyParser = require(&apos;body-parser&apos;)</div><div class="line">let initRouters = require(&apos;./routes/Initialize&apos;)</div><div class="line">const PORT = propReader.get(&apos;server.port&apos;) || 80 // 设置应用占用的端口</div><div class="line"></div><div class="line">// 添加bodyParser和session插件</div><div class="line">app.use(bodyParser.json())</div><div class="line">app.use(bodyParser.urlencoded(&#123; extended: false &#125;))</div><div class="line">app.use(session)</div><div class="line">// 初始化路由</div><div class="line">initRouters(app)  </div><div class="line"></div><div class="line">server.listen(PORT, () =&gt; &#123;</div><div class="line">  console.log(`服务器启动在端口:$&#123;PORT&#125;`)</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p>
<p>好的,上面我们注册了一个httpServer,其中引用了两个自定义的module:<br><code>let session = require(&#39;../framework/redis/session&#39;)</code><br><code>let initRouters = require(&#39;./routes/Initialize&#39;)</code><br>接下来,我们去实现这两个模块.</p>
<p>进入到framework目录,创建redis目录,进入之后创建session.js<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">let session = require(&apos;express-session&apos;)</div><div class="line">let RedisStore = require(&apos;connect-redis&apos;)(session)</div><div class="line">let client = require(&apos;./base&apos;)</div><div class="line"></div><div class="line">module.exports = session(&#123;</div><div class="line">  name: &apos;s&apos;,</div><div class="line">  store: new RedisStore(&#123;</div><div class="line">    client: client,</div><div class="line">    prefix: &apos;RS&apos;  </div><div class="line">  &#125;),</div><div class="line">  secret: &apos;keyboard cat&apos;,  </div><div class="line">  resave: true,</div><div class="line">  saveUninitialized: false</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p>
<p>接着,在本目录创建 base.js<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">let redis = require(&apos;redis&apos;)</div><div class="line">let propReader = require(&apos;properties-reader&apos;)(&apos;server.properties&apos;)</div><div class="line">let client = redis.createClient(propReader.get(&apos;redisServer.port&apos;), propReader.get(&apos;redisServer.ip&apos;), &#123;&#125;)</div><div class="line"></div><div class="line">client</div><div class="line">  .on(&apos;ready&apos;, ()=&gt; &#123;</div><div class="line">    console.log(`redis 连接成功`)</div><div class="line">  &#125;)</div><div class="line">  .on(&apos;reconnecting&apos;, ()=&gt; &#123;</div><div class="line">    console.log(`redis 重连中...`)</div><div class="line">  &#125;)</div><div class="line">  .on(&apos;error&apos;, (err)=&gt; &#123;</div><div class="line">    console.error(`redis 连接出错:$&#123;err&#125;`)</div><div class="line">  &#125;)</div><div class="line"></div><div class="line">module.exports = client</div></pre></td></tr></table></figure></p>
<p>恩,这里我们把配置写到了一个配置文件里,接下来让我们回到根目录,创建配置文件server.properties<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"># server 服务器配置</div><div class="line">server.port=8001</div><div class="line"># dbServer 数据库服务器配置</div><div class="line">dbServer.ip=localhost</div><div class="line">dbServer.port=27010</div><div class="line">dbServer.name=test</div><div class="line"></div><div class="line"># redisServer redis服务器配置</div><div class="line">redisServer.ip=localhost</div><div class="line">redisServer.port=6379</div></pre></td></tr></table></figure></p>
<p>好的,接下来我们要再回到server目录,创建routes文件夹,在下面创建一个叫做Initialize.js的文件,在这里我们要返回一个初始化路由的方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">let indexRoutes = require(&apos;./actions/index&apos;)</div><div class="line">let graphqlRoutes = require(&apos;./graphql/index&apos;)</div><div class="line"></div><div class="line">module.exports = function (app) &#123;</div><div class="line">    app.use(&apos;/&apos;, indexRoutes)</div><div class="line">    app.use(&apos;/graphql&apos;, graphqlRoutes)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们在Initialize里注册两个路由,一个是/index,另外一个是/graphql.<br>其中的index我们先将其创建在server/routes/actions目录中,命名为index.js,简单实现一下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">let router = require(&apos;express&apos;).Router()</div><div class="line"></div><div class="line">router.get([&apos;/&apos;, &apos;/index&apos;], (req, res) =&gt; &#123;</div><div class="line">	res.send(&#123;</div><div class="line">		title: &apos;来啊,互相伤害啊!&apos;,</div><div class="line">	&#125;)</div><div class="line">&#125;)</div><div class="line"></div><div class="line">module.exports = router</div></pre></td></tr></table></figure></p>
<p>接下来需要实现graphql/index.js,但是在这之前,我们要先构建一个用户模型,也就是一个Schema.我们进入core目录创建schemas文件夹,在下面创建user.js<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line">module.exports = function (mongoose) &#123;</div><div class="line">    return mongoose.Schema(&#123;</div><div class="line">        username: &#123;</div><div class="line">            type: String,</div><div class="line">            required: true</div><div class="line">        &#125;,</div><div class="line">        salt: &#123;</div><div class="line">            type: String,</div><div class="line">            required: true</div><div class="line">        &#125;,</div><div class="line">        hash: &#123;</div><div class="line">            type: String,</div><div class="line">            required: true</div><div class="line">        &#125;,</div><div class="line">        nickname: &#123;</div><div class="line">            type: String</div><div class="line">        &#125;,</div><div class="line">        avatar: &#123;</div><div class="line">            type: String,</div><div class="line">            &apos;default&apos;: &apos;/images/avatar_default.jpg&apos;</div><div class="line">        &#125;,</div><div class="line">        gender: &#123;</div><div class="line">            type: String,</div><div class="line">            &apos;enum&apos;: [&apos;男&apos;, &apos;女&apos;]</div><div class="line">        &#125;,</div><div class="line">        age: &#123;</div><div class="line">            type: Number,</div><div class="line">            min: 1,</div><div class="line">            max: 120</div><div class="line">        &#125;,</div><div class="line">        city: &#123;</div><div class="line">            type: String</div><div class="line">        &#125;,</div><div class="line">        hometown: &#123;</div><div class="line">            type: String</div><div class="line">        &#125;,</div><div class="line">        phone: &#123;</div><div class="line">            type: String</div><div class="line">        &#125;,</div><div class="line">        email: &#123;</div><div class="line">            type: String</div><div class="line">        &#125;,</div><div class="line">        birthday: &#123;</div><div class="line">            type: Date</div><div class="line">        &#125;,</div><div class="line">        address: &#123;</div><div class="line">            type: String</div><div class="line">        &#125;,</div><div class="line">        createdate: &#123;</div><div class="line">            type: Date,</div><div class="line">            &apos;default&apos;: Date.now()</div><div class="line">        &#125;</div><div class="line">    &#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后我们在core的根目录里添加一个models.js<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">const mongoose = require(&apos;mongoose&apos;)</div><div class="line">mongoose.Promise = global.Promise</div><div class="line">const propReader = require(&apos;properties-reader&apos;)(&apos;server.properties&apos;)</div><div class="line">let db = mongoose.createConnection(</div><div class="line">    `mongodb://$&#123;propReader.get(&apos;dbServer.ip&apos;)&#125;/$&#123;propReader.get(&apos;dbServer.name&apos;)&#125;`,</div><div class="line">    &#123; replset: &#123; poolSize: 10 &#125; &#125;</div><div class="line">)</div><div class="line"></div><div class="line">// 成功链接数据库</div><div class="line">db.once(&apos;open&apos;, function () &#123;</div><div class="line">    console.log(&apos;mongodb 连接成功!&apos;)</div><div class="line">&#125;)</div><div class="line"></div><div class="line">// 链接数据库失败</div><div class="line">db.on(&apos;error&apos;, function (err) &#123;</div><div class="line">    console.log(`mongodb 连接错误: $&#123;err&#125;`)</div><div class="line">&#125;)</div><div class="line"></div><div class="line">const CREATE_MODEL = function (key, model) &#123;</div><div class="line">    return db.model(key, model)</div><div class="line">&#125;</div><div class="line"></div><div class="line">const SCHEMAS = [&apos;user&apos;]</div><div class="line"></div><div class="line">let schemaMapper = &#123;&#125;</div><div class="line">SCHEMAS.forEach(function (key) &#123;</div><div class="line">    schemaMapper[key] = () =&gt; CREATE_MODEL(key, require(`./schemas/$&#123;key&#125;`)(mongoose))</div><div class="line">&#125;, this)</div><div class="line"></div><div class="line">module.exports = schemaMapper</div></pre></td></tr></table></figure></p>
<p>好的,下面我们就可以回到刚才的server/routes/里创建graphql目录,然后在里面创建index.js:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div></pre></td><td class="code"><pre><div class="line">let UserModel = require(&apos;../../../core/models&apos;).user()  // 获取刚才的用户模型的数据库连接</div><div class="line">let &#123;</div><div class="line">    GraphQLSchema,</div><div class="line">    GraphQLObjectType,</div><div class="line">    GraphQLString,</div><div class="line">    GraphQLList,</div><div class="line">    GraphQLInt,</div><div class="line">    GraphQLNonNull,</div><div class="line">    GraphQLBoolean,</div><div class="line">&#125; = require(&apos;graphql&apos;)</div><div class="line"></div><div class="line">// 创建用户模型对应的graphql类型</div><div class="line">let UserType = new GraphQLObjectType(&#123;</div><div class="line">    name: &apos;user&apos;,</div><div class="line">    description: &apos;user model&apos;,</div><div class="line">    fields: &#123;</div><div class="line">        id: &#123;</div><div class="line">            type: GraphQLString,</div><div class="line">            resolve: o =&gt; o[&apos;_id&apos;]</div><div class="line">        &#125;,</div><div class="line">        nickname: &#123;</div><div class="line">            type: GraphQLString,</div><div class="line">            resolve: o =&gt; o.nickname</div><div class="line">        &#125;,</div><div class="line">        username: &#123;</div><div class="line">            type: GraphQLString,</div><div class="line">            resolve: o =&gt; o.username</div><div class="line">        &#125;,</div><div class="line">        age: &#123;</div><div class="line">            type: GraphQLString,</div><div class="line">            resolve: o =&gt; o.age</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;)</div><div class="line"></div><div class="line">// 创建一个用户的集合类型</div><div class="line">let UserListType = new GraphQLList(UserType)</div><div class="line"></div><div class="line">// 创建graphql的Schema</div><div class="line">let schema = new GraphQLSchema(&#123;</div><div class="line">    query: new GraphQLObjectType(&#123;</div><div class="line">        name: &apos;UsersQuery&apos;,</div><div class="line">        description: &apos;查询用户信息&apos;,</div><div class="line">        fields: &#123;</div><div class="line">            userList: &#123;</div><div class="line">                type: UserListType,</div><div class="line">                description: &apos;用户列表&apos;,</div><div class="line">                resolve(root, param, session) &#123;</div><div class="line">                    return UserModel.find()</div><div class="line">                &#125;</div><div class="line">            &#125;,</div><div class="line">            user: &#123;</div><div class="line">                type: UserType,</div><div class="line">                description: &apos;指定用户信息&apos;,</div><div class="line">                args: &#123;</div><div class="line">                    id: &#123;</div><div class="line">                        type: GraphQLString,</div><div class="line">                        require: true,</div><div class="line">                    &#125;,</div><div class="line">                &#125;,</div><div class="line">                resolve(root, params, session) &#123;</div><div class="line">                    return UserModel.findOne(&#123;</div><div class="line">                        _id: params.id</div><div class="line">                    &#125;)</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;),</div><div class="line">    mutation: new GraphQLObjectType(&#123;</div><div class="line">        name: &apos;UsersMutation&apos;,</div><div class="line">        description: &apos;修改用户信息&apos;,</div><div class="line">        fields: &#123;</div><div class="line">            updateUserProfile: &#123;</div><div class="line">                type: GraphQLBoolean,</div><div class="line">                description: &apos;修改指定用户的个人资料&apos;,</div><div class="line">                args: &#123;</div><div class="line">                    id: &#123;</div><div class="line">                        type: GraphQLString,</div><div class="line">                        require: true,</div><div class="line">                    &#125;,</div><div class="line">                    terms: &#123;</div><div class="line">                        type: GraphQLString,</div><div class="line">                        require: true</div><div class="line">                    &#125;</div><div class="line">                &#125;,</div><div class="line">                resolve(root, params, session) &#123;</div><div class="line">                    let tempModel = JSON.parse(params.terms)</div><div class="line">                    return UserModel</div><div class="line">                        .findOneAndUpdate(&#123;</div><div class="line">                            _id: params.id</div><div class="line">                        &#125;, tempModel)</div><div class="line">                        .then((_d) =&gt; &#123; return !!_d &#125;)  </div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;)</div><div class="line">&#125;)</div><div class="line"></div><div class="line">// 构造graphql的路由</div><div class="line">let graphqlRoutes = require(&apos;express-graphql&apos;)(req =&gt; (&#123;</div><div class="line">    schema: schema,</div><div class="line">    context: req.session,</div><div class="line">    graphiql: true</div><div class="line">&#125;))</div><div class="line"></div><div class="line">module.exports = graphqlRoutes</div></pre></td></tr></table></figure></p>
<p>目前为止,我们已经创建了一个简单的服务器,目录结构是这样的</p>
<p><img src="http://upload-images.jianshu.io/upload_images/140939-afe64974745a40d9.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="tree.jpg"></p>
<p>虽然很多细节并不完善,但是总要一步一步来.</p>
<p>下面让我们在package.json里的scripts下添加一个debug指令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&quot;debug&quot;:&quot;nodemon server/server.js&quot;</div></pre></td></tr></table></figure></p>
<p>保存后,在项目根目录打开控制台 输入<code>npm run debug</code> (确保你的mongodb和redis服务都已经开启)就会看到控制台的输出 服务器已经运行</p>
<p>接下来在浏览器访问<a href="http://localhost:8001" target="_blank" rel="external">http://localhost:8001</a></p>
<p><img src="http://upload-images.jianshu.io/upload_images/140939-5180874a327e2db8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Paste_Image.png"></p>
<p> 也可以访问 <a href="http://localhost:8001/graphql" target="_blank" rel="external">http://localhost:8001/graphql</a> 查看graphql调试器 </p>
<p>我们现在还没有用户数据,所以请求到的结果是空,下一章<a href="http://www.jianshu.com/p/ccd3f3cdc5b4" target="_blank" rel="external">我们将逐步完善服务器端功能,并且开始构建我们的web端之旅</a></p>

        </div>
    

</div>
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/myBlog/2016/09/27/jsFullStackSeries/01/">
                javascript全栈应用实践之路(简述)
            </a>
        </h1>
        <div class="post-info">
            <span class="date">2016-09-27</span>
            
            
        </div>
    </div>

    
        <div class="content">
            <h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p>前一段时间内,我周围的从业IT的老同事/同学/朋友们都或多或少的来找我探讨过一些前端(或者说前端社区)的现象和问题.</p>
<p>所以正巧凑着最近工作不是很忙,就打算搞了个JavaScript全栈的demo.</p>
<p>一来,可以分享给更多关注这一块的朋友,去作为入门参考.<br>二来,也可以作为自己两年多的前端工作经验的阶段性总结.<br>再者,也算是回报社区,毕竟看了这么多大神的帖子也没donate过多少钱,总觉得自己欠社区的.<br>最后,起到一个对未来的敦促作用,万一有朝一日怠惰了,回头看看,说不定还能重燃青春.</p>
<blockquote>
<p>食用本系列文章前请注意:<br>1.由于本文大量涉及ES6的基本语法和特性,如果读者对其不甚是了解,建议先读一下<a href="http://es6.ruanyifeng.com" target="_blank" rel="external">阮一峰老师的入门博客</a><br>2.作为一个全栈入门参考的系列文章,是假设读者们有一定前端基础的. 如果读者在食用时感觉头晕目眩,请留言给我,我会尽量对内容做些许补充说明<br>3.由于本人能力有限,文中出现过激或者错误的观点,烦请读者们悉数指出<br>4.文中并没有什么晦涩难懂或者炫目耀眼的黑魔法,所以注释不会出现得太频繁,请放心食用</p>
</blockquote>
<p><img src="http://upload-images.jianshu.io/upload_images/140939-3fb45a7ef23cb680.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="天真笑容.jpg"></p>
<h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>既然是说全栈,肯定包括了server和client/browser,使用的都是一些耳熟能详的类库/框架.<br>选型可能部分比较保守,譬如选择了express而不是koa等.<br>下面,先大致介绍一下将要涉及的部分类库.</p>
<h6 id="nodejs-服务器端"><a href="#nodejs-服务器端" class="headerlink" title="nodejs 服务器端"></a>nodejs 服务器端</h6><ul>
<li>express 基础框架</li>
<li>connect-redis &amp; express-session 会话组件(会话信息会有持久化 因为开发的时候服务器经常重启 不希望所有的客户端还要重新登录)</li>
<li>graphql &amp; express-graphql 数据服务(相对传统的restful API更灵活,开发高效)</li>
<li>jade 服务器端渲染</li>
<li>socket.io 架设套接字通信服务,经典的应用场景:聊天室</li>
<li>mongoose mongodb的ODM</li>
</ul>
<h6 id="PC端"><a href="#PC端" class="headerlink" title="PC端"></a>PC端</h6><ul>
<li>bootstrap &amp; AdminLTE 样式框架</li>
<li>angularjs@1.x web前端MVVM解决方案</li>
</ul>
<h6 id="Android移动端"><a href="#Android移动端" class="headerlink" title="Android移动端"></a>Android移动端</h6><ul>
<li>react-native 我又不会写原生,既然是js全栈,讲道理嘛</li>
<li>socket.io.client 套接字通信的客户端</li>
</ul>
<h6 id="工程化-开发工具"><a href="#工程化-开发工具" class="headerlink" title="工程化/开发工具"></a>工程化/开发工具</h6><ul>
<li>nodemon 服务器守护进程工具</li>
<li>eslint 编码质量工具</li>
<li>node-sass css预处理</li>
<li>babel 世界正义的卫道士(画风突变)</li>
<li>gulp 任务管理</li>
<li>webpack web资源打包工具</li>
</ul>
<p><a href="http://www.jianshu.com/p/8616aa298cc5" target="_blank" rel="external">下一集:服务器搭建</a></p>

        </div>
    

</div>
            
        </section>
    </div>
</div>






</div>

<!-- Footer -->
<div class="push"></div>

<footer class="footer-content">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 footer-about">
                <h2>关于</h2>
                <p>
                    如果有问题欢迎提ISSUE
                </p>
            </div>
            
    <div class="col-xs-6 col-sm-6 col-md-3 col-lg-3 recent-posts">
        <h2>最近发布</h2>
        <ul>
            
            <li>
                <a class="footer-post" href="/myBlog/2016/09/28/踩过的坑/">踩过的坑</a>
            </li>
            
            <li>
                <a class="footer-post" href="/myBlog/2016/09/28/工具使用/">工具使用</a>
            </li>
            
            <li>
                <a class="footer-post" href="/myBlog/2016/09/28/奇技淫巧/">奇技淫巧</a>
            </li>
            
            <li>
                <a class="footer-post" href="/myBlog/2016/09/27/jsFullStackSeries/03/">javascript全栈应用实践之路 (服务器搭建</a>
            </li>
            
        </ul>
    </div>



            
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <ul class="list-inline footer-social-icons">
                    
                    <li class="list-inline-item">
                        <a href="https://github.com/marsoln/myBlog">
                            <span class="footer-icon-container">
                                <i class="fa fa-github"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://twitter.com/marsoln1988">
                            <span class="footer-icon-container">
                                <i class="fa fa-twitter"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    
                    
                    
                    
                    
                    <li class="list-inline-item">
                        <a href="mailto:marsoln1988@gmail.com">
                            <span class="footer-icon-container">
                                <i class="fa fa-envelope-o"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                </ul>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <div class="footer-copyright">
                    Hexo & Alpha-Dust What A Magic! ❤ by Marsoln
                </div>
            </div>
        </div>
    </div>
</footer>

<!-- After footer scripts -->

<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Tween Max -->
<script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.5/TweenMax.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JavaScript -->
<script src="/myBlog/js/main.js"></script>

<!-- Disqus Comments -->



</body>

</html>